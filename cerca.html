<!DOCTYPE html>
<html lang="it">
<header>
  <div class="top wrap">
    <a class="brand" href="/" aria-label="Echi di Sofia ‚Äì Home">
      <svg class="logo" viewBox="0 0 24 24" width="28" height="28" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
           aria-hidden="true">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
      <span>Echi di Sofia</span>
    </a>

    <div class="spacer"></div>

    <a class="home" href="/" aria-label="Torna all'Incipit">üè† Torna all'Incipit</a>
  </div>

  <!-- SEARCH SECTION -->
  <div class="wrap">
    <div style="margin: 1.5rem 0 0.5rem;">
      <strong style="font-size: 1.2rem;">Cerca</strong>
    </div>
    
    <div class="input-wrap">
      <input type="text" id="site-search" placeholder="Cerca‚Ä¶ (es. Platone, Ipazia, Talete)" autocomplete="off" spellcheck="false">
    </div>
    
    <div class="hint" style="margin-top: 0.5rem;">
      Suggerimento: puoi cercare anche per <em>titolo</em> o parole contenute nella <em>descrizione</em>.
    </div>
  </div>
</header>

<main class="wrap">
  <div id="results" class="results" role="list"></div>
</main>

<footer>¬© 2025 Echi di Sofia</footer>

<script>
(function(){
  // Configurazione URL indice di ricerca
  const SOURCES = (window.SEARCH_INDEX_URLS && window.SEARCH_INDEX_URLS.length)
    ? window.SEARCH_INDEX_URLS
    : ['/search-index.json','/assets/search-index.json'];

  const RESULTS_LIMIT = 60;
  const $q = document.getElementById('site-search'); // CORRETTO: usa site-search invece di q
  const $res = document.getElementById('results');

  // Funzione per normalizzare il testo (rimuove accenti, etc.)
  function norm(s){ 
    return (s||'').toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase(); 
  }

  // Funzione per evidenziare i termini di ricerca
  function highlight(text, query){
    if(!text) return '';
    try{
      const toks = norm(query).split(/\s+/).filter(Boolean);
      if(!toks.length) return text;
      let out = text;
      for(const t of toks){
        if(t.length < 2) continue;
        const re = new RegExp('('+t.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+')','gi');
        out = out.replace(re,'<mark>$1</mark>');
      }
      return out;
    }catch(_){ return text; }
  }

  // Normalizza gli item dell'indice
  function normalize(item){
    const title = item.title || item.name || item.slug || 'Senza titolo';
    const url = (item.url || item.link || '').toString();
    const desc = item.desc || item.description || item.excerpt || item.summary || '';
    return {title, url, desc};
  }

  // Gestisce gli URL
  function href(u){ 
    if(!u) return '#'; 
    if(u.startsWith('http')) return u; 
    if(u.startsWith('/')) return u; 
    return '/'+u.replace(/^\.\//,''); 
  }

  // Crea la card del risultato
  function card(it, query){
    const link = href(it.url);
    const desc = it.desc && it.desc.trim() ? it.desc : '';
    return `<article class="card" role="listitem">
      <a class="title" href="${link}">${highlight(it.title, query)}</a>
      <div class="url">${link}</div>
      ${desc ? `<div class="desc">${highlight(desc, query)}</div>` : ''}
    </article>`;
  }

  // Esegue la ricerca
  function search(items, query){
    const q = norm(query); 
    if(!q) return [];
    
    return items.filter(it => {
      const t = norm(it.title), d = norm(it.desc), u = norm(it.url);
      return t.includes(q) || d.includes(q) || u.includes(q);
    }).slice(0, RESULTS_LIMIT);
  }

  // Renderizza i risultati
  function render(list, query){
    if(!list.length){ 
      $res.innerHTML = `<p style="opacity:.8; text-align:center; padding:2rem;">Nessun risultato per <strong>"${query}"</strong>.</p>`; 
      return; 
    }
    $res.innerHTML = list.map(it => card(it, query)).join('');
  }

  // Debounce per ottimizzare le ricerche
  function debounce(fn, ms){ 
    let t; 
    return (...a) => { 
      clearTimeout(t); 
      t = setTimeout(() => fn(...a), ms); 
    }; 
  }

  let INDEX = [];

  // Carica l'indice di ricerca
  async function loadIndex(){
    for(const u of SOURCES){
      try{
        const r = await fetch(u, {cache: 'no-store'});
        if(!r.ok) continue;
        const data = await r.json();
        console.log('Indice caricato:', data.length || '0', 'elementi');
        return Array.isArray(data) ? data : (data.items || data.entries || []);
      }catch(err){
        console.error('Errore nel caricamento indice da', u, err);
      }
    }
    console.error('Nessun indice di ricerca trovato');
    return [];
  }

  const onInput = debounce(() => {
    const q = $q.value.trim();
    if(!q){ 
      $res.innerHTML = '<p style="opacity:.8; text-align:center; padding:2rem;">Inserisci un termine di ricerca...</p>'; 
      return; 
    }
    const list = search(INDEX, q);
    render(list, q);
  }, 120);

  // Event listeners
  $q.addEventListener('input', onInput);
  $q.addEventListener('keydown', (e) => { 
    if(e.key === 'Enter') onInput(); 
  });

  // Inizializzazione
  loadIndex().then(arr => {
    INDEX = arr.map(normalize);
    console.log('Indice normalizzato:', INDEX.length, 'elementi');
    $q.focus();
    
    // Mostra stato iniziale
    $res.innerHTML = '<p style="opacity:.8; text-align:center; padding:2rem;">Inserisci un termine di ricerca...</p>';
  });
})();
</script>

<!-- Config unica per l'indice -->
<script>
  window.SEARCH_INDEX_URLS = ['/search-index.json?v=20251016','/assets/search-index.json?v=20251016'];
</script>

<script>
// Pulsante cancella (funzionalit√† UI)
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('site-search');
  const inputWrap = document.querySelector('.input-wrap');
  
  if (searchInput && inputWrap) {
    const clearBtn = document.createElement('button');
    clearBtn.type = 'button';
    clearBtn.className = 'clear-btn';
    clearBtn.innerHTML = '‚úï';
    clearBtn.setAttribute('aria-label', 'Cancella ricerca');
    
    inputWrap.appendChild(clearBtn);
    
    function updateClearButton() {
      const hasValue = searchInput.value.trim() !== '';
      clearBtn.style.opacity = hasValue ? '1' : '0';
      clearBtn.style.visibility = hasValue ? 'visible' : 'hidden';
    }
    
    searchInput.addEventListener('input', updateClearButton);
    
    clearBtn.addEventListener('click', function() {
      searchInput.value = '';
      searchInput.focus();
      updateClearButton();
      const inputEvent = new Event('input', { bubbles: true });
      searchInput.dispatchEvent(inputEvent);
    });
    
    updateClearButton();
  }
});
</script>

</body>
</html>
