<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cerca ‚Äî Echi di Sofia</title>
<link rel="icon" type="image/png" href="/favicon_io/favicon-32x32.png">
<style>
:root {
  --bg: #0a0a1a;
  --text: #e9eef5;
  --gold: #ffd86a;
  --cyan: #9ad0ff;
  --panel: rgba(10, 10, 30, .9);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  line-height: 1.5;
}

.wrap {
  width: min(1100px, 94vw);
  margin: 0 auto;
  padding: 1rem 0 2rem;
}

/* HEADER */
header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(10, 10, 30, .96);
  border-bottom: 1px solid rgba(255, 215, 0, .2);
  backdrop-filter: blur(6px);
}

.top {
  display: flex;
  align-items: center;
  gap: .75rem;
  padding: .8rem 1rem;
}

.brand {
  display: flex;
  align-items: center;
  gap: .5rem;
  color: var(--gold);
  font-weight: 800;
  text-decoration: none;
}

.brand img {
  width: 32px;
  height: 32px;
  filter: drop-shadow(0 0 .5rem rgba(255, 215, 0, .35));
}

.brand span {
  background: linear-gradient(90deg, #ffd700, #fff7b0, #ffd700);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  letter-spacing: .04em;
}

.spacer {
  flex: 1;
}

.home {
  color: var(--cyan);
  text-decoration: none;
  font-weight: 700;
  transition: color 0.2s ease;
}

.home:hover {
  color: #fff;
  text-decoration: underline;
}

/* SEARCH AREA */
.search-header {
  padding: 1.5rem 0 0.5rem;
}

#search-title {
  display: block;
  font-size: 1.2rem;
  margin-bottom: 0.8rem;
  color: var(--gold);
}

.input-wrap {
  position: relative;
  display: inline-block;
  width: 100%;
  max-width: 600px;
}

/* Lente a destra */
.input-wrap::before {
  content: "üîç";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  color: #9ad0ff;
  z-index: 2;
  pointer-events: none;
}

/* Campo di ricerca */
#site-search {
  width: 100%;
  padding: 12px 40px 12px 16px;
  background: rgba(20, 20, 40, .85);
  color: #e9eef5;
  border: 1px solid rgba(255, 255, 255, .14);
  border-radius: 10px;
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s ease;
}

#site-search:focus {
  border-color: rgba(0, 204, 255, .6);
}

#site-search::placeholder {
  color: rgba(233, 238, 245, 0.6);
}

/* Pulsante cancella personalizzato */
.clear-btn {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 16px;
  color: #ff6b6b;
  cursor: pointer;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  z-index: 3;
  padding: 4px;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.clear-btn:hover {
  color: #ff4444;
  background: rgba(255, 107, 107, 0.1);
  transform: translateY(-50%) scale(1.1);
}

.clear-btn.visible {
  opacity: 1;
  visibility: visible;
}

/* HINT TEXT */
.hint {
  opacity: .8;
  font-size: .9rem;
  margin-top: 0.5rem;
  color: var(--cyan);
}

.hint em {
  font-style: italic;
  color: var(--gold);
}

/* RESULTS */
.results {
  display: grid;
  gap: .8rem;
  margin-top: 1rem;
}

.card {
  background: var(--panel);
  border: 1px solid rgba(255, 215, 0, .18);
  border-radius: 14px;
  padding: 1.2rem;
  box-shadow: 0 .8rem 2rem rgba(0, 0, 0, .35);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, .4);
}

.card a.title {
  color: var(--gold);
  font-weight: 800;
  text-decoration: none;
  font-size: 1.1rem;
  display: block;
  margin-bottom: 0.3rem;
  transition: color 0.2s ease;
}

.card a.title:hover {
  color: #fff;
  text-decoration: underline;
}

.url {
  font-size: .85rem;
  color: #9bb7ff;
  opacity: .9;
  margin: .2rem 0 .6rem;
  word-break: break-all;
  font-family: monospace;
}

.desc {
  color: #cfe2ff;
  opacity: .95;
  line-height: 1.4;
}

/* HIGHLIGHTING */
mark {
  background: linear-gradient(120deg, rgba(255, 216, 106, 0.3), rgba(154, 208, 255, 0.3));
  color: inherit;
  padding: 0.1em 0.2em;
  border-radius: 0.2em;
}

/* NO RESULTS & PLACEHOLDER */
.results p {
  text-align: center;
  padding: 2rem;
  opacity: 0.8;
  font-style: italic;
}

.results p strong {
  color: var(--gold);
  font-style: normal;
}

/* FOOTER */
footer {
  margin-top: 3rem;
  padding: 1.5rem 1rem;
  text-align: center;
  color: #9ec3ff;
  border-top: 1px solid rgba(255, 255, 255, .06);
  font-size: 0.9rem;
}

/* RESPONSIVE DESIGN */
@media (max-width: 768px) {
  .wrap {
    width: 92vw;
    padding: 0.5rem 0 1.5rem;
  }
  
  .top {
    padding: 0.6rem 0.8rem;
  }
  
  .brand span {
    font-size: 0.9rem;
  }
  
  .home {
    font-size: 0.9rem;
  }
  
  #site-search {
    font-size: 0.95rem;
    padding: 10px 36px 10px 14px;
  }
  
  .card {
    padding: 1rem;
  }
  
  .card a.title {
    font-size: 1rem;
  }
  
  .hint {
    font-size: 0.85rem;
  }
}

@media (max-width: 480px) {
  .top {
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .brand {
    flex: 1;
  }
  
  .spacer {
    display: none;
  }
  
  .home {
    width: 100%;
    text-align: center;
    order: 3;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  #search-title {
    font-size: 1.1rem;
  }
}

/* ANIMATIONS */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card {
  animation: fadeIn 0.3s ease-out;
}

/* SCROLLBAR STYLING */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(10, 10, 30, 0.8);
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 216, 106, 0.3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 216, 106, 0.5);
}

/* FOCUS STYLES FOR ACCESSIBILITY */
a:focus-visible,
button:focus-visible,
input:focus-visible {
  outline: 2px solid var(--cyan);
  outline-offset: 2px;
  border-radius: 2px;
}
</style>
  <style>
  /* Stile essenziale (coerente con Echi di Sofia) */
  .result-item { display:block; padding:.65rem .9rem; margin:.5rem 0; border:1px solid rgba(255,255,255,.12); border-radius:.6rem; background:rgba(255,255,255,.04); text-decoration:none }
  .result-item:hover { background:rgba(255,255,255,.09); }
  .result-title { margin:0 0 .25rem; font-size:1rem; line-height:1.25 }
  .result-desc { margin:.15rem 0 .35rem; font-size:.92rem; line-height:1.4; opacity:.92 }
  .result-cat { display:inline-block; font-size:.75rem; opacity:.75 }
</style>
</head>
<body>
<header>
  <div class="top wrap">
    <a class="brand" href="/" aria-label="Echi di Sofia ‚Äì Home">
      <svg class="logo" viewBox="0 0 24 24" width="28" height="28" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
           aria-hidden="true">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
      <span>Echi di Sofia</span>
    </a>

    <div class="spacer"></div>

    <a class="home" href="/" aria-label="Torna all'Incipit">üè† Torna all'Incipit</a>
  </div>

  <!-- SEARCH SECTION -->
  <div class="wrap">
    <div style="margin: 1.5rem 0 0.5rem;">
      <strong style="font-size: 1.2rem;">Cerca</strong>
    </div>
    
    <div class="input-wrap">
      <input type="text" id="site-search" placeholder="Cerca‚Ä¶ (es. Platone, Ipazia, Talete)" autocomplete="off" spellcheck="false">
    </div>
    
    <div class="hint" style="margin-top: 0.5rem;">
      Suggerimento: puoi cercare anche per <em>titolo</em> o parole contenute nella <em>descrizione</em>.
    </div>
  </div>
</header>

<main class="wrap">
  <div id="results" class="results" role="list"></div>
</main>

<footer>¬© 2025 Echi di Sofia</footer>

<script>
(function(){
  // Configurazione URL indice di ricerca
  const SOURCES = (window.SEARCH_INDEX_URLS && window.SEARCH_INDEX_URLS.length)
    ? window.SEARCH_INDEX_URLS
    : ['/search-index.json','/assets/search-index.json'];

  const RESULTS_LIMIT = 60;
  const $q = document.getElementById('site-search'); // CORRETTO: usa site-search invece di q
  const $res = document.getElementById('results');

  // Funzione per normalizzare il testo (rimuove accenti, etc.)
  function norm(s){ 
    return (s||'').toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase(); 
  }

  // Funzione per evidenziare i termini di ricerca
  function highlight(text, query){
    if(!text) return '';
    try{
      const toks = norm(query).split(/\s+/).filter(Boolean);
      if(!toks.length) return text;
      let out = text;
      for(const t of toks){
        if(t.length < 2) continue;
        const re = new RegExp('('+t.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+')','gi');
        out = out.replace(re,'<mark>$1</mark>');
      }
      return out;
    }catch(_){ return text; }
  }

  // Normalizza gli item dell'indice
  function normalize(item){
    const title = item.title || item.name || item.slug || 'Senza titolo';
    const url = (item.url || item.link || '').toString();
    const desc = item.desc || item.description || item.excerpt || item.summary || '';
    return {title, url, desc};
  }

  // Gestisce gli URL
  function href(u){ 
    if(!u) return '#'; 
    if(u.startsWith('http')) return u; 
    if(u.startsWith('/')) return u; 
    return '/'+u.replace(/^\.\//,''); 
  }

  // Crea la card del risultato
  function card(it, query){
    const link = href(it.url);
    const desc = it.desc && it.desc.trim() ? it.desc : '';
    return `<article class="card" role="listitem">
      <a class="title" href="${link}">${highlight(it.title, query)}</a>
      <div class="url">${link}</div>
      ${desc ? `<div class="desc">${highlight(desc, query)}</div>` : ''}
    </article>`;
  }

  // Esegue la ricerca
  function search(items, query){
    const q = norm(query); 
    if(!q) return [];
    
    return items.filter(it => {
      const t = norm(it.title), d = norm(it.desc), u = norm(it.url);
      return t.includes(q) || d.includes(q) || u.includes(q);
    }).slice(0, RESULTS_LIMIT);
  }

  // Renderizza i risultati
  function render(list, query){
    if(!list.length){ 
      $res.innerHTML = `<p style="opacity:.8; text-align:center; padding:2rem;">Nessun risultato per <strong>"${query}"</strong>.</p>`; 
      return; 
    }
    $res.innerHTML = list.map(it => card(it, query)).join('');
  }

  // Debounce per ottimizzare le ricerche
  function debounce(fn, ms){ 
    let t; 
    return (...a) => { 
      clearTimeout(t); 
      t = setTimeout(() => fn(...a), ms); 
    }; 
  }

  let INDEX = [];

  // Carica l'indice di ricerca
  async function loadIndex(){
    for(const u of SOURCES){
      try{
        const r = await fetch(u, {cache: 'no-store'});
        if(!r.ok) continue;
        const data = await r.json();
        console.log('Indice caricato:', data.length || '0', 'elementi');
        return Array.isArray(data) ? data : (data.items || data.entries || []);
      }catch(err){
        console.error('Errore nel caricamento indice da', u, err);
      }
    }
    console.error('Nessun indice di ricerca trovato');
    return [];
  }

  const onInput = debounce(() => {
    const q = $q.value.trim();
    if(!q){ 
      $res.innerHTML = '<p style="opacity:.8; text-align:center; padding:2rem;">Inserisci un termine di ricerca...</p>'; 
      return; 
    }
    const list = search(INDEX, q);
    render(list, q);
  }, 120);

  // Event listeners
  $q.addEventListener('input', onInput);
  $q.addEventListener('keydown', (e) => { 
    if(e.key === 'Enter') onInput(); 
  });

  // Inizializzazione
  loadIndex().then(arr => {
    INDEX = arr.map(normalize);
    console.log('Indice normalizzato:', INDEX.length, 'elementi');
    $q.focus();
    
    // Mostra stato iniziale
    $res.innerHTML = '<p style="opacity:.8; text-align:center; padding:2rem;">Inserisci un termine di ricerca...</p>';
  });
})();
</script>

<!-- Config unica per l'indice -->
<!-- Indici di ricerca (ordine: locale principale -> eventuali fallback) -->
<script>
  window.SEARCH_INDEX_URLS = [
    '/search-js.html?v=20251029'           // nuovo indice unico (il file che abbiamo appena generato)
    // '/assets/search-js.html?v=20251029'  // opzionale: se in futuro crei una copia in /assets
  ];
</script>
 
 <script>
  // ===== Loader indice (come gi√† messo prima) =====
  async function loadFirstAvailableIndex(urls, timeoutMs = 8000) {
    for (const url of urls) {
      try {
        const ac = new AbortController();
        const to = setTimeout(() => ac.abort(), timeoutMs);
        const res = await fetch(url, { signal: ac.signal, cache: 'no-store' });
        clearTimeout(to);
        if (!res.ok) continue;

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch {
          const m = text.match(/\[\s*\{[\s\S]*\}\s*\]/);
          data = m ? JSON.parse(m[0]) : null;
        }
        if (!data) continue;

        const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : null);
        if (!items) continue;

        // Normalizza i campi minimi
        const norm = items.map((it) => ({
          title: it.title || it.name || '',
          url: it.url || it.href || '#',
          category: it.category || it.section || '',
          description: it.description || it.desc || '',
          date: it.date || ''
        }));
        return norm.filter(x => x.title && x.url);
      } catch {}
    }
    throw new Error('Indice non disponibile');
  }

  // ===== Utility per riconoscere "articoli" veri =====
  function isExternal(u){ return /^https?:\/\//i.test(u); }
  function isAnchor(u){ return u.startsWith('#'); }
  function isLocalHtml(u){ return !isExternal(u) && !isAnchor(u) && /\.html?(\?|#|$)/i.test(u); }

  // directory considerate "contenuti" del sito
  const CONTENT_DIRS = [
    'articoli','Presocratici','filosofi','pagine','Sezioni' // aggiungi/riordina a piacere
  ];
  const CONTENT_DIRS_RE = new RegExp('^(?:\\/)?(' + CONTENT_DIRS.map(d=>d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|') + ')(\\/|$)','i');

  function isLocalArticleLike(item){
    const u = item.url || '';
    const c = (item.category || '').toLowerCase();
    const looksLikePage = isLocalHtml(u) && CONTENT_DIRS_RE.test(u);
    const byCategory = ['articolo','pagina'].includes(c); // estendibile
    return looksLikePage || byCategory;
  }

  // ===== Motore di ricerca =====
  function makeSearchEngine(items) {
    // banca dati + haystack normalizzato
    const bank = items.map((x) => ({
      ...x,
      _hay: (x.title + ' ' + (x.category||'') + ' ' + (x.description||''))
            .toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'')
    }));

    // Ordinatore: prima data (se presente), poi ordine originale
    function sortByDateDesc(list){
      return list.slice().sort((a,b)=>{
        const ad = Date.parse(a.date || '') || 0;
        const bd = Date.parse(b.date || '') || 0;
        return bd - ad;
      });
    }

    function search(q, limit = 100) {
      const query = (q||'').trim();
      // üîπ Caso chiave: query vuota => mostra TUTTI gli articoli locali (non solo 'Sezioni')
      if (!query) {
        const allArticles = bank.filter(isLocalArticleLike);
        return sortByDateDesc(allArticles).slice(0, limit);
      }

      // üîπ Query presente => ricerca inclusiva su tutto
      const qq = query.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
      const terms = qq.split(/\s+/);

      const scored = [];
      for (const it of bank) {
        // tutti i termini devono comparire da qualche parte
        const okAll = terms.every(t => it._hay.includes(t));
        if (!okAll) continue;

        let score = 0;
        // boost titolo
        const t = (it.title||'').toLowerCase();
        if (t.includes(qq)) score += 10;
        // boost se √® "articolo" locale
        if (isLocalArticleLike(it)) score += 3;
        // boost se description pi√π corposa
        if ((it.description||'').length > 80) score += 1;

        scored.push({it, score});
      }
      scored.sort((a,b)=> b.score - a.score);
      return scored.slice(0, limit).map(s=>s.it);
    }

    return { search };
  }

  // ===== Render =====
  function renderResults(results, mountSelector = '#search-results') {
    const root = document.querySelector(mountSelector);
    if (!root) return;
    root.innerHTML = '';

    if (!results.length) {
      root.innerHTML = '<p class="muted">Nessun risultato.</p>';
      return;
    }

    const frag = document.createDocumentFragment();
    for (const r of results) {
      const a = document.createElement('a');
      a.className = 'result-item';
      a.href = r.url;
      a.innerHTML = `
        <h3 class="result-title">${r.title}</h3>
        ${r.description ? `<p class="result-desc">${r.description}</p>` : ''}
        ${r.category ? `<span class="result-cat">${r.category}</span>` : ''}
      `;
      frag.appendChild(a);
    }
    root.appendChild(frag);
  }

  // ===== Init =====
  (async function initSearch(){
    try{
      const urls = (window.SEARCH_INDEX_URLS || ['/search-js.html?v=20251029']).slice();
      const items = await loadFirstAvailableIndex(urls);
      const engine = makeSearchEngine(items);

      // mount
      if (!document.querySelector('#search-results')) {
        const div = document.createElement('div');
        div.id = 'search-results';
        document.body.appendChild(div);
      }

      const input = document.querySelector('#search-input, input[type="search"][name="q"]') || document.querySelector('input[type="search"]');

      function run(q){ renderResults(engine.search(q, 100)); }

      // üî∏ Primo render: TUTTI gli articoli locali (grazie a search(''))
      run('');

      if (input) {
        input.addEventListener('input', e => run(e.target.value));
      }
    }catch(err){
      console.error('Ricerca ‚Äî init error:', err);
      const m = document.querySelector('#search-results');
      if (m) m.innerHTML = '<p class="error">Errore nel caricamento dell‚Äôindice.</p>';
    }
  })();
</script>


<style>
  /* Stile essenziale (coerente con Echi di Sofia) */
  .result-item { display:block; padding:.65rem .9rem; margin:.5rem 0; border:1px solid rgba(255,255,255,.12); border-radius:.6rem; background:rgba(255,255,255,.04); text-decoration:none }
  .result-item:hover { background:rgba(255,255,255,.09); }
  .result-title { margin:0 0 .25rem; font-size:1rem; line-height:1.25 }
  .result-desc { margin:.15rem 0 .35rem; font-size:.92rem; line-height:1.4; opacity:.92 }
  .result-cat { display:inline-block; font-size:.75rem; opacity:.75 }
</style>


<script>
// Pulsante cancella (funzionalit√† UI)
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('site-search');
  const inputWrap = document.querySelector('.input-wrap');
  
  if (searchInput && inputWrap) {
    const clearBtn = document.createElement('button');
    clearBtn.type = 'button';
    clearBtn.className = 'clear-btn';
    clearBtn.innerHTML = '‚úï';
    clearBtn.setAttribute('aria-label', 'Cancella ricerca');
    
    inputWrap.appendChild(clearBtn);
    
    function updateClearButton() {
      const hasValue = searchInput.value.trim() !== '';
      clearBtn.style.opacity = hasValue ? '1' : '0';
      clearBtn.style.visibility = hasValue ? 'visible' : 'hidden';
    }
    
    searchInput.addEventListener('input', updateClearButton);
    
    clearBtn.addEventListener('click', function() {
      searchInput.value = '';
      searchInput.focus();
      updateClearButton();
      const inputEvent = new Event('input', { bubbles: true });
      searchInput.dispatchEvent(inputEvent);
    });
    
    updateClearButton();
  }
});
</script>
</body>
</html>
