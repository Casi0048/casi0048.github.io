<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cerca ‚Äî Echi di Sofia</title>
<link rel="icon" type="image/png" href="/favicon_io/favicon-32x32.png">
<link rel="preload" href="/search-js.html?v=20251029" as="fetch" type="application/json" crossorigin>

<!-- Sorgente unica indice -->
<script>
  (function () {
    window.SEARCH_INDEX_URLS = ['/search-js.html?v=20251029'];
  })();
</script>

<style>
:root { --bg:#0a0a1a; --text:#e9eef5; --gold:#ffd86a; --cyan:#9ad0ff; --panel:rgba(10,10,30,.9) }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.5}
.wrap{width:min(1100px,94vw);margin:0 auto;padding:1rem 0 2rem}

/* HEADER */
header{position:sticky;top:0;z-index:10;background:rgba(10,10,30,.96);border-bottom:1px solid rgba(255,215,0,.2);backdrop-filter:blur(6px)}
.top{display:flex;align-items:center;gap:.75rem;padding:.8rem 1rem}
.brand{display:flex;align-items:center;gap:.5rem;color:var(--gold);font-weight:800;text-decoration:none}
.brand span{background:linear-gradient(90deg,#ffd700,#fff7b0,#ffd700);-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:.04em}
.spacer{flex:1}
.home{color:var(--cyan);text-decoration:none;font-weight:700;transition:color .2s ease}
.home:hover{color:#fff;text-decoration:underline}

/* SEARCH HINT */
.hint{opacity:.8;font-size:.9rem;margin-top:.5rem;color:var(--cyan)}
.hint em{font-style:italic;color:var(--gold)}

/* EXPLORA LAYOUT */
.explora-layout{display:grid;grid-template-columns:260px 1fr;gap:1.25rem;margin-top:1rem}
.explora-side{background:rgba(10,10,30,.9);border:1px solid rgba(255,215,0,.18);border-radius:14px;padding:1rem}
.side-title{margin:.25rem 0 1rem;font-size:1.05rem;color:var(--gold)}
.cat-list{display:flex;flex-direction:column;gap:.25rem}
.cat-item{display:flex;justify-content:space-between;align-items:center;padding:.45rem .6rem;border-radius:.55rem;text-decoration:none;color:#e9eef5;border:1px solid transparent}
.cat-item:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08)}
.cat-item.active{background:linear-gradient(90deg,rgba(255,216,106,.18),rgba(154,208,255,.18));border-color:rgba(255,255,255,.18)}
.cat-name{font-weight:700}
.cat-count{font-family:monospace;opacity:.9}

.explora-toolbar{display:flex;justify-content:flex-end;margin-bottom:.75rem}
.explora-toolbar input[type=search]{width:min(520px,100%);padding:10px 14px;border-radius:10px;background:rgba(20,20,40,.85);border:1px solid rgba(255,255,255,.14);color:#e9eef5}
.article-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem}

/* CARDS */
.article-card{background:var(--panel);border:1px solid rgba(255,215,0,.18);border-radius:14px;padding:1rem;transition:transform .2s ease, box-shadow .2s ease;box-shadow:0 .8rem 2rem rgba(0,0,0,.35);animation:fadeIn .3s ease-out}
.article-card:hover{transform:translateY(-2px);box-shadow:0 1rem 2.5rem rgba(0,0,0,.4)}
.article-card .title{display:block;color:var(--gold);font-weight:800;text-decoration:none;margin-bottom:.25rem}
.article-card .title:hover{text-decoration:underline;color:#fff}
.article-card .url{font-size:.8rem;opacity:.85;color:#9bb7ff;margin:.15rem 0 .5rem;word-break:break-all;font-family:monospace}
.article-card .desc{color:#cfe2ff;opacity:.95;line-height:1.4;font-size:.92rem}

/* Legacy results (se usi #results senza griglia) */
.results{display:grid;gap:.8rem;margin-top:1rem}
.card{background:var(--panel);border:1px solid rgba(255,215,0,.18);border-radius:14px;padding:1.2rem;box-shadow:0 .8rem 2rem rgba(0,0,0,.35);transition:transform .2s ease,box-shadow .2s ease}
.card a.title{color:var(--gold);font-weight:800;text-decoration:none;font-size:1.1rem;display:block;margin-bottom:.3rem}
.card a.title:hover{color:#fff;text-decoration:underline}
.url{font-size:.85rem;color:#9bb7ff;opacity:.9;margin:.2rem 0 .6rem;word-break:break-all;font-family:monospace}
.desc{color:#cfe2ff;opacity:.95;line-height:1.4}

/* HIGHLIGHT */
mark{background:linear-gradient(120deg,rgba(255,216,106,.3),rgba(154,208,255,.3));color:inherit;padding:.1em .2em;border-radius:.2em}

/* FOOTER */
footer{margin-top:3rem;padding:1.5rem 1rem;text-align:center;color:#9ec3ff;border-top:1px solid rgba(255,255,255,.06);font-size:.9rem}

/* RESP */
@media (max-width:1000px){.explora-layout{grid-template-columns:1fr}.explora-side{order:2}.explora-body{order:1}.article-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:560px){.article-grid{grid-template-columns:1fr}}
@media (max-width:768px){.wrap{width:92vw;padding:.5rem 0 1.5rem}.top{padding:.6rem .8rem}}
@media (max-width:480px){.top{flex-wrap:wrap;gap:.5rem}.brand{flex:1}.spacer{display:none}.home{width:100%;text-align:center;order:3;margin-top:.5rem;padding-top:.5rem;border-top:1px solid rgba(255,255,255,.1)}}

/* ANIM */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ACCESSIBILIT√Ä */
a:focus-visible,button:focus-visible,input:focus-visible{outline:2px solid var(--cyan);outline-offset:2px;border-radius:2px}
</style>
</head>
<body>

<header>
  <div class="top wrap">
    <a class="brand" href="/" aria-label="Echi di Sofia ‚Äì Home">
      <svg class="logo" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
      <span>Echi di Sofia</span>
    </a>
    <div class="spacer"></div>
    <a class="home" href="/" aria-label="Torna all'Incipit">üè† Torna all'Incipit</a>
  </div>

  <div class="wrap">
    <div style="margin: 1.5rem 0 0.5rem;"><strong style="font-size: 1.2rem;">Esplora articoli</strong></div>
    <div class="hint">Suggerimento: filtra per <em>titolo</em> o parole nella <em>descrizione</em>; clicca una <em>categoria</em> per restringere.</div>
  </div>
</header>

<main class="wrap">
  <div class="explora-layout">
    <aside class="explora-side">
      <h2 class="side-title">Categorie</h2>
      <nav id="cat-list" class="cat-list" aria-label="Categorie articoli"></nav>
    </aside>
    <section class="explora-body">
      <div class="explora-toolbar">
        <input type="search" id="site-search" placeholder="Filtra‚Ä¶ (titolo/descrizione)" autocomplete="off" spellcheck="false">
      </div>
      <div id="article-grid" class="article-grid" role="list"></div>
    </section>
  </div>
</main>

<footer>¬© 2025 Echi di Sofia</footer>

<script>
/* ===== Config / util ===== */
const INDEX_URL = (window.SEARCH_INDEX_URLS && window.SEARCH_INDEX_URLS[0]) || '/search-js.html?v=20251029';
const FOOTER_SECTIONS_SELECTOR = '.footer-sections, #sezioni, .sezioni-footer'; // se presente, viene nascosto quando ci sono risultati

const norm  = s => (s||'').toString().trim();
const deburr= s => s.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
const isExt = u => /^https?:\/\//i.test(u||'');
const isAnc = u => (u||'').trim().startsWith('#');
const isLocalHtml = u => !isExt(u) && !isAnc(u) && /\.html?(\?|#|$)/i.test(u||'');
// Includi SOLO le vere pagine di contenuto
const CONTENT_RE     = /^(\/)?(articoli|Presocratici|filosofi)(\/|$)/i;
// Escludi directory/segnaposto non desiderati
const EXCLUDE_DIRS   = /^(\/)?(Sezioni|pagine)(\/|$)/i;
// Escludi voci ‚Äúfinto-articolo‚Äù (tipico: ‚ÄúSezione del portale‚Äù)
const EXCLUDE_PHRASES = [/sezione del portale/i];

const isArticleLike = it => {
  const u = it.url || '';
  const c = deburr(it.category || '');
  const d = it.description || '';

  if (!isLocalHtml(u) || isAnc(u)) return false;   // URL locali, non anchor
  if (EXCLUDE_DIRS.test(u))        return false;   // niente /Sezioni, /pagine
  if (c === 'sezione')             return false;   // niente categoria ‚ÄúSezione‚Äù
  if (EXCLUDE_PHRASES.some(rx => rx.test(d))) return false; // niente ‚ÄúSezione del portale‚Äù

  // Articoli veri: cartelle di contenuto o metadato esplicito
  if (CONTENT_RE.test(u)) return true;
  if (c === 'articolo' || c === 'pagina') return true;

  return false;
};

const hideFooterSections = (hasResults) => {
  const f = document.querySelector(FOOTER_SECTIONS_SELECTOR);
  if (f) f.style.display = hasResults ? 'none' : '';
};

/* ===== Loader indice ===== */
async function loadIndex(url=INDEX_URL, timeout=8000){
  const ac = new AbortController(); const to = setTimeout(()=>ac.abort(), timeout);
  const res = await fetch(url, { signal: ac.signal, cache:'no-store' }).catch(()=>null);
  clearTimeout(to);
  if(!res || !res.ok) throw new Error('Indice non disponibile');
  const txt = await res.text();
  let data = null;
  try { data = JSON.parse(txt); }
  catch { const m = txt.match(/\[\s*\{[\s\S]*?\}\s*\]/); data = m ? JSON.parse(m[0]) : null; }
  const arr = Array.isArray(data) ? data : (data && Array.isArray(data.items) ? data.items : []);
  return arr.map(it => ({
    title: norm(it.title || it.name),
    url: norm(it.url || it.href),
    category: norm(it.category || it.section),
    description: norm(it.description || it.desc),
    date: norm(it.date)
  })).filter(x => x.title && x.url);
}

/* ===== Motore ===== */
function makeEngine(items){
  const bank = items.filter(isArticleLike).map(x => ({
    ...x, _hay: deburr(`${x.title} ${x.category||''} ${x.description||''}`)
  }));
  const sortByDate = list => list.slice().sort((A,B)=>(Date.parse(B.date||'')||0)-(Date.parse(A.date||'')||0));
  const search = (q, limit=500) => {
    const query = norm(q);
    if(!query) return sortByDate(bank).slice(0, limit);
    const terms = deburr(query).split(/\s+/);
    const scored = [];
    for (const it of bank){
      if (!terms.every(t => it._hay.includes(t))) continue;
      let s=0;
      if (deburr(it.title).includes(deburr(query))) s+=8;
      if ((it.description||'').length>80) s+=1;
      scored.push({it,s});
    }
    scored.sort((a,b)=>b.s-a.s);
    return scored.slice(0,limit).map(o=>o.it);
  };
  return { search, data: bank };
}

/* ===== Categorie ===== */
function buildCategories(items){
  const map = new Map();
  for (const it of items){
    const raw = norm(it.category) || 'Senza categoria';
    map.set(raw, (map.get(raw)||0) + 1);
  }
  return Array.from(map.entries()).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
}
function renderCategories(list, activeKey=null){
  const nav = document.getElementById('cat-list');
  if(!nav) return;
  nav.innerHTML = '';
  const total = list.reduce((acc, [,n])=>acc+n,0);
  const make = (label, key, count) => {
    const a = document.createElement('a');
    a.href = '#';
    a.className = 'cat-item' + (activeKey===key ? ' active':'');
    a.dataset.key = key||'';
    a.innerHTML = `<span class="cat-name">${label}</span><span class="cat-count">${count}</span>`;
    return a;
  };
  nav.appendChild(make('Tutte', '', total));
  for (const [cat, n] of list){ nav.appendChild(make(cat, cat, n)); }
}

/* ===== Render griglia ===== */
function renderGrid(items){
  const root = document.getElementById('article-grid') || document.getElementById('results');
  if(!root) return;
  root.innerHTML = '';
  if(!items.length){
    root.innerHTML = '<p class="muted">Nessun articolo.</p>';
    hideFooterSections(false);
    return;
  }
  hideFooterSections(true);
  const frag = document.createDocumentFragment();
  for (const it of items){
    const card = document.createElement('article');
    card.className = 'article-card';
    card.innerHTML = `
      <a class="title" href="${it.url}">${it.title}</a>
      <div class="url">${it.url}</div>
      ${it.description ? `<div class="desc">${it.description}</div>` : ''}
      ${it.category ? `<div class="desc" style="opacity:.75;margin-top:.35rem;"><strong>${it.category}</strong></div>` : ''}
    `;
    frag.appendChild(card);
  }
  root.appendChild(frag);
}

/* ===== Init ===== */
(function(){
  let currentCat = null;

  (async function(){
    try{
      const items = await loadIndex();
      const engine = makeEngine(items);

      // Categorie
      const cats = buildCategories(engine.data);
      renderCategories(cats, null);

      // Tutti gli articoli all‚Äôavvio
      renderGrid(engine.search('', 500));

      // Filtro testo
      const input = document.getElementById('site-search');
      const doFilter = () => {
        const q = input ? input.value : '';
        let res = engine.search(q, 500);
        if (currentCat){
          res = res.filter(it => (norm(it.category)||'Senza categoria') === currentCat);
        }
        renderGrid(res);
      };
      if (input){
        input.addEventListener('input', doFilter);
        const form = input.closest('form'); if(form) form.addEventListener('submit', e => { e.preventDefault(); doFilter(); });
      }

      // Click categorie
      const nav = document.getElementById('cat-list');
      if (nav){
        nav.addEventListener('click', (e) => {
          const a = e.target.closest('a.cat-item'); if(!a) return;
          e.preventDefault();
          currentCat = a.dataset.key || null; // '' = tutte
          nav.querySelectorAll('.cat-item').forEach(el => el.classList.toggle('active', el === a));
          doFilter();
        });
      }
    }catch(err){
      console.error('Esplora ‚Äî errore init:', err);
      const root = document.getElementById('article-grid') || document.getElementById('results');
      if (root) root.innerHTML = '<p class="error">Errore nel caricamento dell‚Äôindice.</p>';
    }
  })();
})();
</script>

</body>
</html>
